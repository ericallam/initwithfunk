<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Sync | initWithFunk:]]></title>
  <link href="http://initwithfunk.com/blog/categories/sync/atom.xml" rel="self"/>
  <link href="http://initwithfunk.com/"/>
  <updated>2015-06-26T15:47:29+01:00</updated>
  <id>http://initwithfunk.com/</id>
  <author>
    <name><![CDATA[Eric Allam]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[As I Learn CloudKit Syncing - Part 1: Asking Questions]]></title>
    <link href="http://initwithfunk.com/blog/2015/06/26/as-i-learn-cloudkit-syncing-part-1/"/>
    <updated>2015-06-26T15:01:00+01:00</updated>
    <id>http://initwithfunk.com/blog/2015/06/26/as-i-learn-cloudkit-syncing-part-1</id>
    <content type="html"><![CDATA[<p>I described in <a href="http://initwithfunk.com/blog/2015/06/26/as-i-learn-cloudkit-part-0/">the first part</a> of this series, I&rsquo;m adopting the &ldquo;Little Data, Lots of Clients&rdquo; CloudKit syncing strategy for syncing <a href="http://twitter.com">Qiktionary</a> game data.</p>

<p><img src='http://f.cl.ly/items/0d0i1Z2h1S0L453y1E0C/LittleDataLotsOfClients.png' style="-webkit-box-shadow: 0 0 0px !important; box-shadow: 0 0 0px !important; -moz-box-shadow: 0 0 0px !important;" /></p>

<p>Both the <a href="https://developer.apple.com/videos/wwdc/2014/?id=231">Advanced CloudKit</a> talk from 2014 and the <a href="https://developer.apple.com/videos/wwdc/2015/?id=715">CloudKit Tips and Tricks</a> talk from this year cover how to use CloudKit in this way, but in a very high-level way:</p>

<ul>
<li>Use a custom <code>CKRecordZone</code> in the user&rsquo;s private database.</li>
<li>Custom zones support atomic modifications (only commit the changes if all changes can occur)</li>
<li>Custom zones also support fetching a &ldquo;diff&rdquo; of changes that have occurred since the last sync using the <code>CKFetchRecordChangesOperation</code> class</li>
<li>Custom zones allow you to create a <code>CKSubscription</code> that will notify clients of any changes to a zone, allowing the client to fetch the changes with the aforementioned <code>CKFetchRecordChangesOperation</code></li>
<li><code>CKRecord</code> has support for serializing only the metadata fields for storage alongside the local record using <code>- encodeSystemFieldsWithCoder:</code>.</li>
<li><code>CKRecord</code>&rsquo;s can be submitted back up to iCloud with just the metadata fields and fields that have changed. Which means you don&rsquo;t have to fetch an entire <code>CKRecord</code> before updating it.</li>
</ul>


<p>This seems to be the basic machinery useful in building CloudKit syncing. In <a href="https://developer.apple.com/videos/wwdc/2014/?id=231">Advanced CloudKit</a>, they also layout a recipe to follow when performing a sync:</p>

<ol>
<li>Track local changes</li>
<li>Send changes to the server</li>
<li>Resolve conflicts</li>
<li>Fetch server changes with <code>CKFetchRecordChangesOperation</code></li>
<li>Apply server changes</li>
<li>Save server change token</li>
</ol>


<p>One of the main strengths of CloudKit is how un-opinionated it is. As just a transport mechanism, it&rsquo;s very flexible in how you structure your application and architecture. What this means though is that there is a lot more left to figure out on your own. At this point in the journey, here are all the things I&rsquo;m left to figure out:</p>

<ul>
<li>How do I track local changes? Should I hook into sqlite and listen for all changes made to the tables I&rsquo;m syncing and create some sort of &ldquo;changes&rdquo; table. What does that table look like?</li>
<li>When do I perform a sync? At app launch? Every 60 seconds? Whenever anything changes? When the app is backgrounded?</li>
<li>What about when a record is deleted? I can&rsquo;t just delete it from the local database anymore? Maybe that can go into the &ldquo;changes&rdquo; database too?</li>
<li>How do I deal with conflict errors when sending modifications to the server? Actually, the fact that CloudKit is making me answer this question is great, I should be forced to figure this one out. Core Data syncing suffered because it hid too much of this from the programmer.</li>
<li>What if iCloud is down? Or the device has a bad connection? Or the server is busy? Or iCloud rate limits me? Or there is no iCloud account? Or the user switches iCloud accounts? Or I&rsquo;m sending too much data?</li>
<li>Since Qiktionary is already out, what kind of problems will I run into migrating people&rsquo;s data when they first open the app after Qiktionary w/syncing is released? What if Qiktionary tries to do the initial import on both a person&rsquo;s iPhone and iPad at the same time?</li>
<li>A whole other class of questions related to architecture and writing clean code. What&rsquo;s the best way to go about that?</li>
<li>Also, for Qiktionary, this all has to corresponding to a Game Center account. So the local games are all syncing to iCloud under a certain GC account. If the user switches to a different GC account, the games don&rsquo;t go along with them. This means they could be playing on multiple GC accounts on a single iCloud account. Question: How?</li>
<li>Zone Subscriptions are another concern. They aren&rsquo;t 100% necessary but they should help to answer at least half of the &ldquo;when do I sync&rdquo; question. But they come with their own questions, like: when do I ask the user for permission to send them push notifications for this purpose? Is it a little silly to say hey I need your permission for push notifications because: sync?</li>
<li>How do I do this all in a way that doesn&rsquo;t break other things, like duplicating games or lost games, overwriting games, scores, and achievements?</li>
</ul>


<p>Since I am a couple of days into this now, I think I have a couple of these questions nailed down (I&rsquo;ve even written some code so a few of those answers have survived that test), but many are still open questions, which I will trying to answer as this work (and this series) continues for the next couple of weeks.</p>

<p>Stay tuned for Part 2. Get notified of new posts by <a href="http://twitter.com/eallam">following me on Twitter</a>. In the meantime <a href="http://qiktionary.com">download Qiktionary</a> and learn some cool facts :).</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[As I Learn CloudKit Syncing - Part 0]]></title>
    <link href="http://initwithfunk.com/blog/2015/06/26/as-i-learn-cloudkit-part-0/"/>
    <updated>2015-06-26T12:40:00+01:00</updated>
    <id>http://initwithfunk.com/blog/2015/06/26/as-i-learn-cloudkit-part-0</id>
    <content type="html"><![CDATA[<p><img src='http://f.cl.ly/items/1V343x033m0j352I1S40/Screen%20Shot%202015-06-26%20at%201.57.23%20pm.png' style="-webkit-box-shadow: 0 0 0px !important; box-shadow: 0 0 0px !important; -moz-box-shadow: 0 0 0px !important;" /></p>

<p>We released <a href="http://qiktionary.com">Qiktionary</a> a little over a month ago. It&rsquo;s a playful word game that allows players to unlock interesting facts by solving a mastermindish word puzzle. There are two modes: single player (the main game) and multiplayer where you can challenge your friends on Game Center to a round of three games. Qiktionary works on both iPhone and iPad.</p>

<p>Since it works on both the iPhone and the iPad, we considered the possibility of adding syncing. We knew some people would play on both their iPhone and iPad and would want their games to sync to all their devices. Multiplayer is built on top of Game Center matchmaking so we already have syncing there taken care of; but single player data is all just stored locally in a sqlite database.</p>

<p>I punted on syncing until a week ago when I started implementing Game Center leaderboards and achievements for the single player game. Without syncing, the following scenario is likely to happen to people that play on both an iPhone and an iPad on the same Game Center account:</p>

<ul>
<li>Play many games on their iPhone, earning achievements that unlock prizes and rocket them up the leaderboard. The sqlite database on their iPhone diligently holds the records for all these games played. Game Center stores the info about their leaderboard scores and achievements</li>
<li>Put down their iPhone and pick up their iPad, which doesn&rsquo;t know anything about all those games hidden away on their iPhone</li>
<li>Qiktionary on the iPad shows them all these achievements they&rsquo;ve earned even though locally they haven&rsquo;t played a single game.</li>
<li>Play a game on their iPad. Qiktionary updates their score on the leaderboard based on that single game. Player rockets back down the leaderboard. Qiktionary also attempted to award them the &ldquo;played your first game&rdquo; achievement even though they&rsquo;ve already played many games on their iPhone.</li>
<li>Player is sad.</li>
<li>Player leaves bad review on App Store.</li>
<li>Qiktionary is sad.</li>
</ul>


<p>So it seems to me that there is no way of <a href="http://stackoverflow.com/questions/31007080/how-have-you-dealt-with-with-game-center-leaderboards-in-your-universal-game">getting around implementing syncing</a> when doing Game Center leaderboards/achievements for a univeral iOS game.</p>

<p>Which brings me to CloudKit.</p>

<p>I don&rsquo;t have a lot of time to build in syncing. I&rsquo;m not going to be running my own servers. There isn&rsquo;t a ton of data to sync (if a player completely finishes Qiktionary they will have only generated at most 10MB). Qiktionary for now is iOS only and even if we do expand to other platforms I&rsquo;m okay with the new CloudKit REST and JS APIs being sufficient to support that move. CloudKit also has nice support for this type of syncing strategy (which they call tiny data, all devices).</p>

<p>So: CloudKit. This is what I&rsquo;m using and I&rsquo;ve been learning all I can about it the last couple of days. I&rsquo;ve watched all the WWDC sessions (some multiple times). <a href="https://developer.apple.com/videos/wwdc/2014/?id=208">Introducing CloudKit</a> and <a href="https://developer.apple.com/videos/wwdc/2014/?id=231">Advanced CloudKit</a> from last year and <a href="https://developer.apple.com/videos/wwdc/2015/?id=715">CloudKit Tips and Tricks</a> from this year were especially helpful. The <a href="https://developer.apple.com/videos/wwdc/2015/?id=226">Advanced NSOperations</a> talk from this year has also given me a strategy for working with CloudKit operations that I think I am happy with (I&rsquo;ll cover this in a future post). There isn&rsquo;t a ton of Sample Code but I&rsquo;ve learned some from the <a href="https://developer.apple.com/library/prerelease/ios/samplecode/CloudAtlas/Introduction/Intro.html">CloudKit Catalog</a> and the <a href="https://cdn.apple-cloudkit.com/cloudkit-catalog/">live JS version</a> is pretty helpful for quickly getting a feel for the APIs. I&rsquo;ve also learned a lot by looking at the source for the newly released <a href="https://github.com/CloudKitSpace/CKSIncrementalStore">CKSIncrementalStore</a>.</p>

<p>There are a decent amount of CloudKit tutorials out there but I&rsquo;ve found most of them are focused on the Big Data, Tiny Phone strategy of CloudKit. This is the strategy used by things like iCloud Photos.</p>

<p>Which is why I am writing this series (shamefully copying David Smith&rsquo;s <a href="https://david-smith.org/watchkit/">As I Learn watchOS</a> series). I&rsquo;ve just started implementing sync but I am going to try and talk through some of the problems I run into and figure out which things work and which things don&rsquo;t.</p>

<p>Stay tuned for Part 1 where I will be talking through the &ldquo;Tiny Data, All Devices&rdquo; strategy of CloudKit.</p>

<p>Be notified of new posts by <a href="http://twitter.com/eallam">following me on Twitter</a>. In the meantime <a href="http://qiktionary.com">download Qiktionary</a> and learn some cool facts :).</p>
]]></content>
  </entry>
  
</feed>
